using UnityEngine;
using System.Collections;

public class MarioController : MonoBehaviour
{
    [Header("???????")]
    public float moveSpeed = 8f;
    public float jumpForce = 16f;

    [Header("??????")]
    public AnimatorOverrideController bigMarioController;
    private RuntimeAnimatorController smallMarioController;
    private SpriteRenderer spriteRenderer;
    private BoxCollider2D col; // ?????????????????

    [Header("???????")]
    public LayerMask groundLayer;
    public Transform groundCheck;
    public float checkRadius = 0.2f;

    private Rigidbody2D rb;
    private Animator anim;
    private bool isGrounded;
    private bool isBig = false;
    private bool inPowerUpSequence;

    /// <summary> ????????????????????????????? true ???????????????? </summary>
    public bool IsBig => isBig;

    void Start()
    {
        rb = GetComponent<Rigidbody2D>();
        anim = GetComponent<Animator>();
        spriteRenderer = GetComponent<SpriteRenderer>();
        col = GetComponent<BoxCollider2D>(); // ???????????
        smallMarioController = anim.runtimeAnimatorController;
    }

    void Update()
    {
        // 1. ??????
        isGrounded = Physics2D.OverlapCircle(groundCheck.position, checkRadius, groundLayer);

        // 2. ???????
        float moveInput = Input.GetAxisRaw("Horizontal");
        // ??? Unity 6 ????? linearVelocity
        rb.linearVelocity = new Vector2(moveInput * moveSpeed, rb.linearVelocity.y);

        // 3. ?????? (??????????????????)
        // ????? moveInput ??? 0 ?????? flipX????????????????????
        // 3. ?????? (??????????????????????????????????)
        // ??? rb.linearVelocity.x ??? moveInput???????????????????????????????????????
        if (rb.linearVelocity.x > 0.1f)
        {
            spriteRenderer.flipX = false;
        }
        else if (rb.linearVelocity.x < -0.1f)
        {
            spriteRenderer.flipX = true;
        }
        // ????????? 0 ??????????????????????????????????????

        // 4. ???
        if (Input.GetButtonDown("Jump") && isGrounded)
        {
            rb.linearVelocity = new Vector2(rb.linearVelocity.x, jumpForce);
        }

        // 5. ???????? (???? E ??)
        if (Input.GetKeyDown(KeyCode.E) && !inPowerUpSequence)
        {
            StartCoroutine(PowerUpSequence());
        }

        // --- ???? Animator ???? ---
        anim.SetFloat("Speed", Mathf.Abs(rb.linearVelocity.x));
        anim.SetBool("isGrounded", isGrounded);
        anim.SetFloat("verticalVelocity", rb.linearVelocity.y);
    }

    IEnumerator PowerUpSequence()
    {
        inPowerUpSequence = true;
        anim.SetTrigger("onPowerUp");

        yield return new WaitForSeconds(0.5f);

        isBig = !isBig;
        anim.runtimeAnimatorController = isBig ? bigMarioController : smallMarioController;

        inPowerUpSequence = false;

        // --- ??????????? Center ????????????? ---
        // ?????????? Hs??????? Hb?????????????????????? Offset ???????
        // Offset = (Hb - Hs) / 2
        //if (isBig)
        //{
        //    col.size = new Vector2(0.8f, 1.2f);   // ??????????? 1.8
        //    col.offset = new Vector2(0f, 0.1f);  // (1.8 - 1.0) / 2 = 0.4
        //}
        //else
        //{
        //    col.size = new Vector2(0.8f, 1.0f);   // ?????????? 1.0
        //    col.offset = new Vector2(0f, 0f);    // ???????
        //}
    }

    /// <summary> ????????????? MarioCombat ?????????????????????????????????? </summary>
    public void ShrinkToSmall()
    {
        if (!isBig) return;
        isBig = false;
        if (anim != null && smallMarioController != null)
            anim.runtimeAnimatorController = smallMarioController;
    }

    private void OnDrawGizmos()
    {
        if (groundCheck != null)
        {
            Gizmos.color = Color.red;
            Gizmos.DrawWireSphere(groundCheck.position, checkRadius);
        }
    }
}